<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Parque de las Heliconias - Panel de Control</title>

        <!-- CSS -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white; /* Fondo blanco */
                z-index: -1;
            }
            /* Header Styles */
            /* Header Styles */
            .header {
                background: linear-gradient(135deg, #ffffff, #ffffff);
                color: #2e7d32;
                padding: 15px 30px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .top-section {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .logo {
                display: flex;           /* Activar flexbox */
                align-items: center;     /* Centrar verticalmente el contenido */
                gap: 15px;               /* Espacio entre logo y t√≠tulo */
            }

            .logo-img {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .logo-img i {
                display: block;
                width: 100%;
                height: 100%;
                background-image: url("img/logo.png");
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                font-size: 0; 
                color: transparent;
            }

            .logo h1 {
                font-size: 24px;
                font-weight: 700;
                margin: 0;
            }
            
            .top-bar {
                display: flex;
                justify-content: space-between; /* izquierda - derecha */
                align-items: center;            /* misma l√≠nea */
                width: 100%;
                margin-bottom: 10px;
                margin-top: 15px; 
            }

            .system-date {
                display: flex;
                margin-left: 20px;
                align-items: center;
                gap: 10px;
                font-weight: 500;
                color: #000000;
                background: rgba(255, 255, 255, 0.15); /* efecto cristal */
                padding: 10px 18px;
                border-radius: 25px;
                backdrop-filter: blur(6px);  /* efecto vidrio borroso */
                -webkit-backdrop-filter: blur(6px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.25);
                font-size: 15px;
                letter-spacing: 0.5px;        /* m√°s elegante */
            }

            /* Navigation Styles */
            .nav-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-top: 10px;
                border-top: 1px solid rgba(255,255,255,0.3);
            }

            .main-nav {
                display: flex;
                gap: 5px;
                left: 50px;/* ajusta el valor para mover m√°s a la izquierda o derecha */
            }

            .nav-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                color: #2e7d32;
                text-decoration: none;
                border-radius: 6px;
                position: relative;
                background: transparent; /* quitar fondo */
                transition: all 0.3s ease;
            }

            /* L√≠nea inferior al pasar el mouse */
            .nav-item::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 10%;           /* margen izquierdo de la l√≠nea */
                width: 80%;          /* ancho de la l√≠nea */
                height: 2px;         /* grosor de la l√≠nea */
                background: linear-gradient(135deg, #2e7d32, #4caf50);
                transform: scaleX(0); /* inicialmente invisible */
                transition: transform 0.3s ease;
                transform-origin: center;
            }

            .nav-item:hover::after {
                transform: scaleX(1); /* l√≠nea aparece */
            }

            .user-actions {
                display: flex;        /* ya estaba flex */
                justify-content: flex-end;  /* esto los lleva a la derecha */
                gap: 10px; 
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                transition: all 0.3s ease;
                position: relative;
                left: -20px; /* mueve cada bot√≥n 20px hacia la izquierda */
            }

            .btn-primary {
                background: linear-gradient(135deg, #2e7d32, #4caf50); /* verde degradado */
                color: white;
            }


            .btn-accent {
                background: linear-gradient(135deg, #e74c3c, #fe5926); 
                color: white;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            /* Main Content Styles */
            .main-content {
                padding: 30px;
            }

            .titulo {
                background: white;
                padding: 25px 30px;
                margin-bottom: 25px;
                font-size: 1.5rem;
                color: #2c3e50;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                border-left: 5px solid #2e7d32;
            }

            .titulo i {
                color: #2e7d32;
                margin-right: 10px;
            }

            /* Content Grid */
            .content {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 25px;
            }

            .content-section {
                background: white;
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s ease;
                border-top: 4px solid #2e7d32;
            }

            .content-section:hover {
                transform: translateY(-5px);
            }

            .section-title {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 20px;
                color: #2c3e50;
                font-size: 1.2rem;
            }

            .stat-icon {
                color: #2e7d32;
                font-size: 1.4rem;
            }

            .stat-number {
                font-size: 3rem;
                font-weight: bold;
                color: #2e7d32;
                text-align: center;
                margin: 20px 0;
            }

            .stats-container {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #2e7d32;
            }

            .stat-label {
                font-weight: 500;
                color: #2c3e50;
            }

            .stat-value {
                font-weight: bold;
                color: #2e7d32;
                font-size: 1.2rem;
            }

            .no-data {
                text-align: center;
                color: #7f8c8d;
                font-style: italic;
                padding: 20px;
            }

            .section-actions {
                margin-top: 20px;
                text-align: center;
            }

            .btn-details {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                background: linear-gradient(135deg, #2e7d32, #4caf50); /* verde degradado */
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .btn-details:hover {
                background: #2e7d32;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            }

            .btn-details:disabled {
                background: #bdc3c7;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .nav-container {
                    flex-direction: column;
                    gap: 15px;
                }
                
                .main-nav {
                    flex-wrap: wrap;
                    justify-content: center;
                }
            }

            @media (max-width: 768px) {
                .header {
                    padding: 15px;
                }
                
                .top-section {
                    flex-direction: column;
                    gap: 15px;
                    text-align: center;
                }
                
                .content {
                    grid-template-columns: 1fr;
                    padding: 15px;
                }
                
                .main-content {
                    padding: 15px;
                }
                
                .user-actions {
                    flex-wrap: wrap;
                    justify-content: flex-end; /* alineaci√≥n a la derecha */
                    gap: 10px; /* espacio entre botones */
                }
                
                .nav-item {
                    padding: 8px 12px;
                    font-size: 0.9rem;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="top-section">
                <div class="logo">
                    <div class="logo-img">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h1>Heliconias Reports</h1>
                </div>
                    <!-- Navegaci√≥n horizontal -->
                <nav class="main-nav">
                    <a href="principal.html" class="nav-item active tooltip">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                    <a href="eventos.html" class="nav-item tooltip">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Eventos</span>
                    </a>
                    <a href="actividad.html" class="nav-item tooltip">
                        <i class="fas fa-hiking"></i>
                        <span>Actividades</span>
                    </a>
                    <a href="reportes.html" class="nav-item tooltip">
                        <i class="fas fa-chart-line"></i>
                        <span>Reportes</span>
                    </a>
                    <a href="configuracion.html" class="nav-item tooltip">
                        <i class="fas fa-cog"></i>
                        <span>Configuraci√≥n</span>
                    </a>
                </nav>
            </div>
        </header>

        <div class="top-bar">
            <div class="system-date">
                <i class="fas fa-clock"></i>
                <span id="current-date-time">Cargando fecha y hora...</span>
            </div>

            <div class="user-actions">
                <a href="soporte.html" class="btn btn-primary tooltip">
                    <i class="fas fa-headset"></i> Soporte
                </a>

                <button class="btn btn-primary tooltip" id="help-btn">
                    <i class="fas fa-question-circle"></i> Ayuda
                </button>

                <button class="btn btn-accent tooltip" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
        <main class="main-content">
            <h2 class="titulo">
                <i class="fas fa-chart-pie"></i>Resumen Financiero y Estad√≠sticas de Visitantes
            </h2>

            <!-- Contenido -->
            <div class="content">
                <!-- Total de Visitantes -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-users stat-icon"></i>Total de visitantes
                    </h2>
                    <div class="stat-number" id="total-visitantes">Cargando...</div>
                    <div class="section-actions">
                        <a href="estadisticas_visitantes.html" class="btn-details">
                            <i class="fas fa-chart-pie"></i> Ver Estad√≠sticas 
                        </a>
                    </div>
                </div>

                <!-- Por G√©nero -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-venus-mars stat-icon"></i>Por g√©nero
                    </h2>
                    <div class="stats-container" id="genero-stats-container">
                        <!-- Los g√©neros se cargar√°n din√°micamente aqu√≠ -->
                        <div class="no-data">Cargando g√©neros...</div>
                    </div>
                    <div class="section-actions">
                        <a href="estadisticas_genero.html" class="btn-details">
                            <i class="fas fa-chart-pie"></i> Ver Detalles
                        </a>
                    </div>
                </div>

                <!-- Por Edad -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-child stat-icon"></i>Por edad
                    </h2>
                    <div class="stats-container" id="edad-stats-container">
                        <!-- Las edades se cargar√°n din√°micamente aqu√≠ -->
                        <div class="no-data">Cargando edades...</div>
                    </div>
                    <div class="section-actions">
                        <a href="estadisticas_edad.html" class="btn-details">
                            <i class="fas fa-chart-bar"></i> Ver Detalles
                        </a>
                    </div>
                </div>

                <!-- Por Nacionalidad -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-flag stat-icon"></i>Por nacionalidad
                    </h2>
                    <div class="stats-container" id="nacionalidad-stats-container">
                        <!-- Las nacionalidades se cargar√°n din√°micamente aqu√≠ -->
                        <div class="no-data">Cargando nacionalidades...</div>
                    </div>
                    <div class="section-actions">
                        <a href="estadisticas_nacionalidad.html" class="btn-details">
                            <i class="fas fa-chart-bar"></i> Ver Detalles
                        </a>
                    </div>
                </div>

                <!-- Por Ciudad -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-city stat-icon"></i>Por ciudad
                    </h2>
                    <div class="stats-container">
                        <div class="stat-item">
                            <span class="stat-label">Bogot√°</span>
                            <span class="stat-value" id="ciudad-bogota">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Medell√≠n</span>
                            <span class="stat-value" id="ciudad-medellin">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Cali</span>
                            <span class="stat-value" id="ciudad-cali">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Otras</span>
                            <span class="stat-value" id="ciudad-otras">Sin datos</span>
                        </div>
                    </div>
                    <div class="section-actions">
                        <a href="estadisticas_ciudad.html" class="btn-details"> 
                            <i class="fas fa-map-marked-alt"></i> Ver Detalles
                        </a>
                    </div>
                </div>

                <!-- Por Instituci√≥n - ACTUALIZADO -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-school stat-icon"></i>Por instituci√≥n
                    </h2>
                    <div class="stats-container">
                        <div class="stat-item">
                            <span class="stat-label">Universidad del Valle</span>
                            <span class="stat-value" id="institucion-univalle">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Universidad Nacional</span>
                            <span class="stat-value" id="institucion-nacional">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Universidad de los Andes</span>
                            <span class="stat-value" id="institucion-andes">Sin datos</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Otras Instituciones</span>
                            <span class="stat-value" id="institucion-otras">Sin datos</span>
                        </div>
                    </div>
                    <div class="section-actions">
                        <a href="estadisticas_institucion.html" class="btn-details">
                            <i class="fas fa-university"></i> Ver Detalles
                        </a>
                    </div>
                </div>

                <!-- Gesti√≥n Financiera -->
                <div class="content-section">
                    <h2 class="section-title">
                        <i class="fas fa-dollar-sign stat-icon"></i>Gesti√≥n Financiera
                    </h2>
                    <p class="no-data">M√≥dulo en desarrollo</p>
                    <div class="section-actions">
                        <button class="btn-details" disabled>
                            <i class="fas fa-chart-line"></i> Ver Detallesüîê
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- JS -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- Supabase JS -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        
        <script>
            // Inicializar Supabase
            const supabaseUrl = 'https://umncnddwzmjxgmvisvqz.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtbmNuZGR3em1qeGdtdmlzdnF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1NDIyNzksImV4cCI6MjA3ODExODI3OX0.ODvus28cTCTD8gGewQ2sAZ8PcXbEe4CIy_zv6bip8J0';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Funci√≥n para actualizar fecha y hora
            function updateDateTime() {
                const now = new Date();
                const dateTimeString = now.toLocaleString("es-ES", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true,
                });

                const dateTimeElement = document.getElementById("current-date-time");
                if (dateTimeElement) {
                    dateTimeElement.textContent = dateTimeString;
                }
            }

            // Funci√≥n para calcular edad a partir de fecha de nacimiento
            function calcularEdad(fechaNacimiento) {
                if (!fechaNacimiento) return null;
                
                const hoy = new Date();
                const nacimiento = new Date(fechaNacimiento);
                
                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                const mes = hoy.getMonth() - nacimiento.getMonth();
                
                // Ajustar si a√∫n no ha pasado el mes de cumplea√±os
                if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                    edad--;
                }
                
                return edad;
            }

            // Funci√≥n para clasificar por edad
            function clasificarEdad(edad) {
                if (edad < 18) return 'menores';
                if (edad <= 60) return 'adultos';
                return 'mayores';
            }

            // Funci√≥n para obtener datos de visitantes desde Supabase
            async function cargarDatosVisitantes() {
                try {
                    console.log('Iniciando carga de datos de visitantes...');
                    
                    // Consulta simple para obtener todos los registros de participantes_reserva
                    const { data: visitantesData, error: visitantesError } = await supabase
                        .from('participantes_reserva')
                        .select('id_participante');
                    
                    console.log('Datos obtenidos de visitantes:', visitantesData);
                    
                    if (visitantesError) {
                        console.error('Error al cargar visitantes:', visitantesError);
                        document.getElementById('total-visitantes').textContent = 'Error en BD';
                        return;
                    }
                    
                    // Actualizar total de visitantes
                    const totalVisitantes = visitantesData ? visitantesData.length : 0;
                    document.getElementById('total-visitantes').textContent = totalVisitantes.toLocaleString();
                    
                    console.log('Total de visitantes:', totalVisitantes);
                    
                } catch (error) {
                    console.error('Error al cargar datos de visitantes:', error);
                    document.getElementById('total-visitantes').textContent = 'Error';
                }
            }

            // Funci√≥n para cargar datos de g√©nero din√°micamente
            async function cargarDatosGenero() {
                try {
                    console.log('=== CARGANDO DATOS DE G√âNERO DIN√ÅMICAMENTE ===');
                    
                    // Consulta todos los participantes con id_genero
                    const { data: participantes, error } = await supabase
                        .from('participantes_reserva')
                        .select('id_genero')
                        .not('id_genero', 'is', null);

                    if (error) {
                        console.error('Error al cargar datos de g√©nero:', error);
                        mostrarErrorGenero();
                        return;
                    }

                    console.log('Datos de g√©nero obtenidos:', participantes);

                    // Contar g√©neros por ID
                    const conteoGeneros = {};
                    
                    participantes.forEach(participante => {
                        const idGenero = participante.id_genero;
                        if (idGenero) {
                            conteoGeneros[idGenero] = (conteoGeneros[idGenero] || 0) + 1;
                        }
                    });

                    console.log('Conteo por ID de g√©nero:', conteoGeneros);

                    // Crear mapeo de nombres de g√©nero din√°micamente
                    const nombresGenero = {
                        1: 'Masculino',
                        2: 'Femenino',
                        3: 'No binario',
                        4: 'Prefiero no decir',
                        5: 'Otro'
                        // Se agregar√°n autom√°ticamente m√°s IDs si existen
                    };

                    // Generar la interfaz din√°micamente
                    generarInterfazGeneros(conteoGeneros, nombresGenero);

                } catch (error) {
                    console.error('Error cr√≠tico en cargarDatosGenero:', error);
                    mostrarErrorGenero();
                }
            }

            // Funci√≥n para generar la interfaz de g√©neros din√°micamente
            function generarInterfazGeneros(conteoGeneros, nombresGenero) {
                const statsContainer = document.getElementById('genero-stats-container');
                
                // Limpiar contenedor
                statsContainer.innerHTML = '';

                // Si no hay datos
                if (Object.keys(conteoGeneros).length === 0) {
                    statsContainer.innerHTML = '<div class="no-data">No hay datos de g√©nero</div>';
                    return;
                }

                // Ordenar g√©neros por cantidad (mayor a menor)
                const generosOrdenados = Object.keys(conteoGeneros).sort((a, b) => {
                    return conteoGeneros[b] - conteoGeneros[a];
                });

                // Crear elementos para cada g√©nero
                generosOrdenados.forEach(idGenero => {
                    const cantidad = conteoGeneros[idGenero];
                    const nombre = nombresGenero[idGenero] || `G√©nero ${idGenero}`;
                    
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.innerHTML = `
                        <span class="stat-label">${nombre}</span>
                        <span class="stat-value">${cantidad.toLocaleString()}</span>
                    `;
                    
                    statsContainer.appendChild(statItem);
                });

                console.log('‚úÖ Interfaz de g√©neros generada din√°micamente');
            }

            // Funci√≥n para cargar datos de edad din√°micamente
            async function cargarDatosEdad() {
                try {
                    console.log('=== CARGANDO DATOS DE EDAD DIN√ÅMICAMENTE ===');
                    
                    // Consulta todos los participantes con fecha_nacimiento
                    const { data: participantes, error } = await supabase
                        .from('participantes_reserva')
                        .select('fecha_nacimiento')
                        .not('fecha_nacimiento', 'is', null);

                    if (error) {
                        console.error('Error al cargar datos de edad:', error);
                        mostrarErrorEdad();
                        return;
                    }

                    console.log('Datos de edad obtenidos:', participantes);

                    // Inicializar contadores
                    const conteoEdades = {
                        menores: 0,
                        adultos: 0,
                        mayores: 0
                    };

                    // Calcular edades y clasificar
                    participantes.forEach(participante => {
                        const fechaNacimiento = participante.fecha_nacimiento;
                        if (fechaNacimiento) {
                            const edad = calcularEdad(fechaNacimiento);
                            if (edad !== null) {
                                const categoria = clasificarEdad(edad);
                                conteoEdades[categoria]++;
                            }
                        }
                    });

                    console.log('Conteo por categor√≠a de edad:', conteoEdades);

                    // Generar la interfaz din√°micamente
                    generarInterfazEdades(conteoEdades);

                } catch (error) {
                    console.error('Error cr√≠tico en cargarDatosEdad:', error);
                    mostrarErrorEdad();
                }
            }

            // Funci√≥n para generar la interfaz de edades din√°micamente
            function generarInterfazEdades(conteoEdades) {
                const statsContainer = document.getElementById('edad-stats-container');
                
                // Limpiar contenedor
                statsContainer.innerHTML = '';

                // Si no hay datos
                if (conteoEdades.menores === 0 && conteoEdades.adultos === 0 && conteoEdades.mayores === 0) {
                    statsContainer.innerHTML = '<div class="no-data">No hay datos de edad</div>';
                    return;
                }

                // Crear elementos para cada categor√≠a de edad
                const categorias = [
                    { key: 'menores', label: 'Menores de 18' },
                    { key: 'adultos', label: '18 - 60 a√±os' },
                    { key: 'mayores', label: 'Mayores de 60' }
                ];

                categorias.forEach(categoria => {
                    const cantidad = conteoEdades[categoria.key];
                    
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.innerHTML = `
                        <span class="stat-label">${categoria.label}</span>
                        <span class="stat-value">${cantidad.toLocaleString()}</span>
                    `;
                    
                    statsContainer.appendChild(statItem);
                });

                console.log('‚úÖ Interfaz de edades generada din√°micamente');
            }

            // Funci√≥n para cargar datos de nacionalidad - COLOMBIA vs OTROS PA√çSES
            async function cargarDatosNacionalidad() {
                try {
                    console.log('=== CARGANDO DATOS DE NACIONALIDAD - COLOMBIA vs OTROS ===');
                    
                    // 1. Obtener todos los participantes con id_ciudad
                    const { data: participantes, error: errorParticipantes } = await supabase
                        .from('participantes_reserva')
                        .select('id_ciudad')
                        .not('id_ciudad', 'is', null);

                    if (errorParticipantes) {
                        console.error('Error al obtener participantes:', errorParticipantes);
                        mostrarErrorNacionalidad();
                        return;
                    }

                    console.log('Participantes con ciudades:', participantes);

                    if (!participantes || participantes.length === 0) {
                        mostrarSinDatosNacionalidad();
                        return;
                    }

                    // 2. Obtener todos los IDs de ciudades √∫nicos
                    const idsCiudadesUnicos = [...new Set(participantes.map(p => p.id_ciudad))];
                    console.log('IDs de ciudades √∫nicos:', idsCiudadesUnicos);

                    // 3. Obtener informaci√≥n de ciudades con sus pa√≠ses
                    const { data: ciudades, error: errorCiudades } = await supabase
                        .from('ciudades')
                        .select(`
                            id, 
                            pais_id,
                            pais (
                                id,
                                pais
                            )
                        `)
                        .in('id', idsCiudadesUnicos);

                    if (errorCiudades) {
                        console.error('Error al obtener ciudades:', errorCiudades);
                        mostrarErrorNacionalidad();
                        return;
                    }

                    console.log('Ciudades obtenidas con pa√≠ses:', ciudades);

                    // 4. Contar participantes por pa√≠s
                    const conteoPaises = {};
                    let sinPaisCount = 0;

                    participantes.forEach(participante => {
                        const ciudad = ciudades.find(c => c.id === participante.id_ciudad);
                        
                        if (ciudad && ciudad.pais && ciudad.pais.pais) {
                            const nombrePais = ciudad.pais.pais;
                            conteoPaises[nombrePais] = (conteoPaises[nombrePais] || 0) + 1;
                        } else {
                            // Si no encontramos el pa√≠s
                            sinPaisCount++;
                        }
                    });

                    console.log('Conteo completo por pa√≠s:', conteoPaises);
                    console.log('Sin pa√≠s:', sinPaisCount);

                    // 5. Separar Colombia de otros pa√≠ses
                    let colombiaCount = 0;
                    let otrosPaisesCount = 0;

                    Object.keys(conteoPaises).forEach(nombrePais => {
                        if (nombrePais.toLowerCase().includes('colombia')) {
                            colombiaCount += conteoPaises[nombrePais];
                        } else {
                            otrosPaisesCount += conteoPaises[nombrePais];
                        }
                    });

                    // Agregar los que no tienen pa√≠s a "Otros pa√≠ses"
                    otrosPaisesCount += sinPaisCount;

                    const conteoFinal = {
                        'Colombia': colombiaCount,
                        'Otros pa√≠ses': otrosPaisesCount
                    };

                    console.log('Conteo final:', conteoFinal);
                    generarInterfazNacionalidades(conteoFinal);

                } catch (error) {
                    console.error('Error en cargarDatosNacionalidad:', error);
                    mostrarErrorNacionalidad();
                }
            }

            // Funci√≥n para generar la interfaz de nacionalidades
            function generarInterfazNacionalidades(conteoNacionalidades) {
                const statsContainer = document.getElementById('nacionalidad-stats-container');
                
                // Limpiar contenedor
                statsContainer.innerHTML = '';

                // Crear elementos para Colombia y Otros pa√≠ses
                const categorias = [
                    { label: 'Colombia', value: conteoNacionalidades['Colombia'] || 0 },
                    { label: 'Otros pa√≠ses', value: conteoNacionalidades['Otros pa√≠ses'] || 0 }
                ];

                categorias.forEach(categoria => {
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.innerHTML = `
                        <span class="stat-label">${categoria.label}</span>
                        <span class="stat-value">${categoria.value.toLocaleString()}</span>
                    `;
                    
                    statsContainer.appendChild(statItem);
                });

                console.log('‚úÖ Interfaz de nacionalidades generada');
            }

            // Funci√≥n para cargar datos de ciudades - ACTUALIZADA
            async function cargarDatosCiudad() {
                try {
                    console.log('=== CARGANDO DATOS DE CIUDAD ===');
                    
                    // 1. Obtener todos los participantes con id_ciudad
                    const { data: participantes, error: errorParticipantes } = await supabase
                        .from('participantes_reserva')
                        .select('id_ciudad')
                        .not('id_ciudad', 'is', null);

                    if (errorParticipantes) {
                        console.error('Error al obtener participantes:', errorParticipantes);
                        mostrarErrorCiudad();
                        return;
                    }

                    console.log('Participantes con ciudades:', participantes);

                    if (!participantes || participantes.length === 0) {
                        mostrarSinDatosCiudad();
                        return;
                    }

                    // 2. Obtener todos los IDs de ciudades √∫nicos
                    const idsCiudadesUnicos = [...new Set(participantes.map(p => p.id_ciudad))];
                    console.log('IDs de ciudades √∫nicos:', idsCiudadesUnicos);

                    // 3. Obtener informaci√≥n de ciudades con sus nombres
                    const { data: ciudades, error: errorCiudades } = await supabase
                        .from('ciudades')
                        .select(`
                            id, 
                            nombre
                        `)
                        .in('id', idsCiudadesUnicos);

                    if (errorCiudades) {
                        console.error('Error al obtener ciudades:', errorCiudades);
                        mostrarErrorCiudad();
                        return;
                    }

                    console.log('Ciudades obtenidas:', ciudades);

                    // 4. Contar participantes por ciudad
                    const conteoCiudades = {};
                    let sinCiudadCount = 0;

                    participantes.forEach(participante => {
                        const ciudad = ciudades.find(c => c.id === participante.id_ciudad);
                        
                        if (ciudad && ciudad.nombre) {
                            const nombreCiudad = ciudad.nombre;
                            conteoCiudades[nombreCiudad] = (conteoCiudades[nombreCiudad] || 0) + 1;
                        } else {
                            // Si no encontramos la ciudad
                            sinCiudadCount++;
                        }
                    });

                    console.log('Conteo completo por ciudad:', conteoCiudades);
                    console.log('Sin ciudad:', sinCiudadCount);

                    // 5. Separar ciudades principales de Colombia vs otras ciudades
                    let bogotaCount = 0;
                    let medellinCount = 0;
                    let caliCount = 0;
                    let otrasCiudadesCount = 0;

                    Object.keys(conteoCiudades).forEach(nombreCiudad => {
                        const cantidad = conteoCiudades[nombreCiudad];
                        
                        if (nombreCiudad.toLowerCase().includes('bogot√°') || nombreCiudad.toLowerCase().includes('bogota')) {
                            bogotaCount += cantidad;
                        } else if (nombreCiudad.toLowerCase().includes('medell√≠n') || nombreCiudad.toLowerCase().includes('medellin')) {
                            medellinCount += cantidad;
                        } else if (nombreCiudad.toLowerCase().includes('cali')) {
                            caliCount += cantidad;
                        } else {
                            otrasCiudadesCount += cantidad;
                        }
                    });

                    // Agregar los que no tienen ciudad a "Otras ciudades"
                    otrasCiudadesCount += sinCiudadCount;

                    console.log('Conteo final ciudades:', {
                        'Bogot√°': bogotaCount,
                        'Medell√≠n': medellinCount,
                        'Cali': caliCount,
                        'Otras': otrasCiudadesCount
                    });

                    // 6. Actualizar la interfaz con los datos reales
                    actualizarInterfazCiudades(bogotaCount, medellinCount, caliCount, otrasCiudadesCount);

                } catch (error) {
                    console.error('Error en cargarDatosCiudad:', error);
                    mostrarErrorCiudad();
                }
            }

            // Funci√≥n para actualizar la interfaz de ciudades
            function actualizarInterfazCiudades(bogota, medellin, cali, otras) {
                // Actualizar los elementos existentes en el HTML
                document.getElementById('ciudad-bogota').textContent = bogota.toLocaleString();
                document.getElementById('ciudad-medellin').textContent = medellin.toLocaleString();
                document.getElementById('ciudad-cali').textContent = cali.toLocaleString();
                document.getElementById('ciudad-otras').textContent = otras.toLocaleString();

                console.log('‚úÖ Interfaz de ciudades actualizada');
            }

            // Funci√≥n para actualizar la interfaz de instituciones
function actualizarInterfazInstituciones(univalle, nacional, andes, otras) {
    try {
        console.log('Actualizando interfaz instituciones:', { univalle, nacional, andes, otras });
        
        // Actualizar los elementos existentes en el HTML
        document.getElementById('institucion-univalle').textContent = univalle.toLocaleString();
        document.getElementById('institucion-nacional').textContent = nacional.toLocaleString();
        document.getElementById('institucion-andes').textContent = andes.toLocaleString();
        document.getElementById('institucion-otras').textContent = otras.toLocaleString();

        console.log('‚úÖ Interfaz de instituciones actualizada');
    } catch (error) {
        console.error('Error al actualizar interfaz instituciones:', error);
    }
}

// Funci√≥n para mostrar sin datos en instituci√≥n
function mostrarSinDatosInstitucion() {
    try {
        document.getElementById('institucion-univalle').textContent = '0';
        document.getElementById('institucion-nacional').textContent = '0';
        document.getElementById('institucion-andes').textContent = '0';
        document.getElementById('institucion-otras').textContent = '0';
    } catch (error) {
        console.error('Error en mostrarSinDatosInstitucion:', error);
    }
}

// Funci√≥n para mostrar error en la secci√≥n de instituci√≥n
function mostrarErrorInstitucion() {
    try {
        document.getElementById('institucion-univalle').textContent = 'Error';
        document.getElementById('institucion-nacional').textContent = 'Error';
        document.getElementById('institucion-andes').textContent = 'Error';
        document.getElementById('institucion-otras').textContent = 'Error';
    } catch (error) {
        console.error('Error en mostrarErrorInstitucion:', error);
    }
}

// Funci√≥n para cargar datos de instituciones - CORREGIDA
async function cargarDatosInstitucion() {
    try {
        console.log('=== CARGANDO DATOS DE INSTITUCI√ìN ===');
        
        // 1. Obtener todos los participantes con id_institucion
        const { data: participantes, error: errorParticipantes } = await supabase
            .from('participantes_reserva')
            .select('id_institucion')
            .not('id_institucion', 'is', null);

        if (errorParticipantes) {
            console.error('Error al obtener participantes:', errorParticipantes);
            mostrarErrorInstitucion();
            return;
        }

        console.log('Participantes con instituciones:', participantes);

        if (!participantes || participantes.length === 0) {
            mostrarSinDatosInstitucion();
            return;
        }

        // 2. Obtener todos los IDs de instituciones √∫nicos
        const idsInstitucionesUnicos = [...new Set(participantes.map(p => p.id_institucion))];
        console.log('IDs de instituciones √∫nicos:', idsInstitucionesUnicos);

        // 3. Obtener informaci√≥n de instituciones - CON LOS NOMBRES CORRECTOS DE CAMPOS
        let todasLasInstituciones = [];

        // Consulta corregida con los nombres reales de campos
        const { data: instituciones, error: errorInstituciones } = await supabase
            .from('instituciones')
            .select('id_institucion, nombre_institucion')  // Campos corregidos
            .order('nombre_institucion');

        if (errorInstituciones) {
            console.error('Error al obtener instituciones:', errorInstituciones);
            mostrarErrorInstitucion();
            return;
        }

        todasLasInstituciones = instituciones || [];
        console.log('Todas las instituciones obtenidas:', todasLasInstituciones);

        // 4. Contar participantes por instituci√≥n - CORREGIDO
        const conteoInstituciones = {};
        let sinInstitucionCount = 0;

        participantes.forEach(participante => {
            // Usar id_institucion en lugar de id
            const institucion = todasLasInstituciones.find(i => i.id_institucion === participante.id_institucion);
            
            if (institucion && institucion.nombre_institucion) {
                const nombreInstitucion = institucion.nombre_institucion;
                conteoInstituciones[nombreInstitucion] = (conteoInstituciones[nombreInstitucion] || 0) + 1;
            } else {
                // Si no encontramos la instituci√≥n
                sinInstitucionCount++;
            }
        });

        console.log('Conteo completo por instituci√≥n:', conteoInstituciones);
        console.log('Sin instituci√≥n:', sinInstitucionCount);

        // 5. Separar instituciones principales vs otras instituciones
        let univalleCount = 0;
        let nacionalCount = 0;
        let andesCount = 0;
        let otrasInstitucionesCount = 0;

        Object.keys(conteoInstituciones).forEach(nombreInstitucion => {
            const cantidad = conteoInstituciones[nombreInstitucion];
            const nombreLower = nombreInstitucion.toLowerCase();
            
            if (nombreLower.includes('universidad del valle') || nombreLower.includes('univalle')) {
                univalleCount += cantidad;
            } else if (nombreLower.includes('universidad nacional') || nombreLower.includes('nacional de colombia')) {
                nacionalCount += cantidad;
            } else if (nombreLower.includes('universidad de los andes') || nombreLower.includes('uniandes')) {
                andesCount += cantidad;
            } else {
                otrasInstitucionesCount += cantidad;
            }
        });

        // Agregar los que no tienen instituci√≥n a "Otras instituciones"
        otrasInstitucionesCount += sinInstitucionCount;

        console.log('Conteo final instituciones:', {
            'Universidad del Valle': univalleCount,
            'Universidad Nacional': nacionalCount,
            'Universidad de los Andes': andesCount,
            'Otras': otrasInstitucionesCount
        });

        // 6. Actualizar la interfaz con los datos reales
        actualizarInterfazInstituciones(univalleCount, nacionalCount, andesCount, otrasInstitucionesCount);

    } catch (error) {
        console.error('Error en cargarDatosInstitucion:', error);
        mostrarErrorInstitucion();
    }
}

            // Funciones de manejo de errores y estados
            function mostrarSinDatosNacionalidad() {
                const statsContainer = document.getElementById('nacionalidad-stats-container');
                statsContainer.innerHTML = '<div class="no-data">No hay datos de nacionalidad</div>';
            }

            function mostrarErrorNacionalidad() {
                const statsContainer = document.getElementById('nacionalidad-stats-container');
                statsContainer.innerHTML = '<div class="no-data">Error al cargar datos de nacionalidad</div>';
            }

            function mostrarSinDatosCiudad() {
                document.getElementById('ciudad-bogota').textContent = '0';
                document.getElementById('ciudad-medellin').textContent = '0';
                document.getElementById('ciudad-cali').textContent = '0';
                document.getElementById('ciudad-otras').textContent = '0';
            }

            function mostrarErrorCiudad() {
                document.getElementById('ciudad-bogota').textContent = 'Error';
                document.getElementById('ciudad-medellin').textContent = 'Error';
                document.getElementById('ciudad-cali').textContent = 'Error';
                document.getElementById('ciudad-otras').textContent = 'Error';
            }

            function mostrarSinDatosInstitucion() {
                document.getElementById('institucion-univalle').textContent = '0';
                document.getElementById('institucion-nacional').textContent = '0';
                document.getElementById('institucion-andes').textContent = '0';
                document.getElementById('institucion-otras').textContent = '0';
            }

            function mostrarErrorInstitucion() {
                document.getElementById('institucion-univalle').textContent = 'Error';
                document.getElementById('institucion-nacional').textContent = 'Error';
                document.getElementById('institucion-andes').textContent = 'Error';
                document.getElementById('institucion-otras').textContent = 'Error';
            }

            function mostrarErrorGenero() {
                const statsContainer = document.getElementById('genero-stats-container');
                statsContainer.innerHTML = '<div class="no-data">Error al cargar datos de g√©nero</div>';
            }

            function mostrarErrorEdad() {
                const statsContainer = document.getElementById('edad-stats-container');
                statsContainer.innerHTML = '<div class="no-data">Error al cargar datos de edad</div>';
            }

            // Funci√≥n para cargar todos los datos
            async function cargarTodosLosDatos() {
                try {
                    console.log('üöÄ Iniciando carga de todos los datos...');
                    
                    // Cargar datos de visitantes
                    await cargarDatosVisitantes();
                    
                    // Cargar datos de g√©nero
                    await cargarDatosGenero();
                    
                    // Cargar datos de edad
                    await cargarDatosEdad();
                    
                    // Cargar datos de nacionalidad
                    await cargarDatosNacionalidad();

                    // Cargar datos de ciudad
                    await cargarDatosCiudad();

                    // Cargar datos de instituci√≥n
                    await cargarDatosInstitucion();
                    
                    console.log('‚úÖ Todos los datos cargados exitosamente');
                    
                } catch (error) {
                    console.error('‚ùå Error al cargar todos los datos:', error);
                }
            }

            // Inicializar fecha y hora
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Cargar datos cuando la p√°gina est√© lista
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM cargado, iniciando carga de datos...');
                
                // Cargar todos los datos
                cargarTodosLosDatos();
            });

            // Bot√≥n de ayuda del panel principal
            document.getElementById("help-btn").addEventListener("click", function () {
                Swal.fire({
                    title: '<div style="display: flex; align-items: center; gap: 10px; color: #2c3e50;"><i class="fas fa-chart-pie" style="color: #3498db; font-size: 1.5rem;"></i><span>Centro de Ayuda - Panel Principal</span></div>',
                    html: `
                        <div style="text-align: left;">
                            <div style="background: linear-gradient(135deg, #3498db, #2c3e50); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-info-circle"></i>
                                    ¬øQu√© hace esta interfaz?
                                </h4>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 20px;">
                                <p style="margin: 0 0 10px 0; color: #2c3e50; font-size: 0.95rem;">
                                    <i class="fas fa-seedling" style="color: #27ae60; margin-right: 8px;"></i>
                                    En este apartado encontrar√°s informaci√≥n y tus reportes importantes para tus informes. 
                                    Tambi√©n podr√°s ver detalladamente el parque con sus datos del pasado y presente.
                                </p>
                                <p style="margin: 0; color: #2c3e50; font-size: 0.95rem;">
                                    <i class="fas fa-heart" style="color: #e74c3c; margin-right: 8px;"></i>
                                    Esperamos que sea de tu agrado.
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-star"></i>
                                    Funcionalidades Principales
                                </h4>
                            </div>
                            
                            <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                                    <i class="fas fa-chart-bar" style="color: #3498db; font-size: 1.2rem; margin-top: 2px;"></i>
                                    <div>
                                        <strong style="color: #2c3e50;">Visualizaci√≥n de Datos</strong>
                                        <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9rem;">Consulta informaci√≥n detallada y estad√≠sticas en tiempo real del parque</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e74c3c;">
                                    <i class="fas fa-history" style="color: #e74c3c; font-size: 1.2rem; margin-top: 2px;"></i>
                                    <div>
                                        <strong style="color: #2c3e50;">Reportes Hist√≥ricos</strong>
                                        <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9rem;">Accede a datos del pasado y presente para an√°lisis comparativos</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #f39c12;">
                                    <i class="fas fa-file-alt" style="color: #f39c12; font-size: 1.2rem; margin-top: 2px;"></i>
                                    <div>
                                        <strong style="color: #2c3e50;">Informes Importantes</strong>
                                        <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9rem;">Genera y visualiza tus reportes con informaci√≥n clave del parque</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    showCloseButton: true,
                    confirmButtonColor: '#3498db',
                    confirmButtonText: '<i class="fas fa-check-circle"></i> Entendido',
                    width: 650,
                    background: '#ffffff'
                });
            });

            // Bot√≥n de salir - Ahora con confirmaci√≥n
            document.getElementById("logout-btn").addEventListener("click", function() {
                Swal.fire({
                    title: '¬øEst√°s seguro?',
                    text: "¬øQuieres cerrar sesi√≥n?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#27ae60',
                    cancelButtonColor: '#e74c3c',
                    confirmButtonText: 'S√≠, salir',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Mostrar mensaje de "Saliendo..."
                        Swal.fire({
                            title: 'Saliendo...',
                            text: "Cerrando sesi√≥n",
                            icon: 'info',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true,
                            didOpen: () => {
                                Swal.showLoading()
                            }
                        }).then(() => {
                            // Redirigir a index.html despu√©s de mostrar el mensaje
                            window.location.href = 'index.html';
                        });
                    }
                });
            });
        </script>
    </body>
</html>